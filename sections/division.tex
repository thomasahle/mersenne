%! TEX root = ../mersenne.tex

\section{Division and Modulo with Generalized Mersenne Primes}
\label{sec:division}

The purpose of this section is to prove the correctness of Algorithm \ref{alg:division-generalized}.
In particular we will prove the following equivalent mathematical statement:

\begin{theorem}\label{thm:simple-div}
   Given integers $q>c>0$, $n\ge 0$ and
   %\todo{Do we support negative $c$? Can we instead say $q>|c|>0$?}
   $$0\le x \le \begin{cases}
      c (q/c)^{n} - c &\quad\text{if } c \setminus q \\
      (q/c)^{n-1}(q-c) &\quad\text{otherwise}
      %q^{n} - 1 &\quad\text{if } c = 1 \\
   \end{cases}.$$
   Define the sequence $(v_i)_{i\in[n]}$ by
   $
      v_0 = 0$ and
      $v_{i+1} = \left\lfloor\frac{(v_i+1)c+x}{q}\right\rfloor$.
   Then
   $$
      \left\lfloor\frac{x}{q-c}\right\rfloor = v_n.$$
   %\todo{Given the Corollary, we can also write this as $x < (q/c)^n$, which may be easier to understand?}
\end{theorem}
We note that when $c<q-1$ a sufficient requirement is that $x< (q/c)^n$.
For $c=q-1$ we are computing $\floor{x/1}$ so we do not need to run the algorithm at all.

To be more specific, the error $E_i = \floor{\frac{x}{q-c}} - v_i$ at each step
%The value at each step satisfy $v_i = \floor{\frac{x}{q-c}} - E_i$ where
%the errors $E_i$ are never negative.
is bounded by $0\le E_i\le u_{n-i}$,
where $u_i$ is a sequence defined by
$u_0=0$ and $u_{i+1} = \lfloor\frac{q}{c}u_i+1\rfloor$.
For example, this means that if we stop the algorithm after $n-1$ steps, the error will be at most $u_1=1$.
\begin{proof}
   Write $x = m(q-c)+h$ for non-negative integers $m$ and $h$ with $h<q-c$.
   Then we get
   \begin{align*}
      \left\lfloor\frac{x}{q-c}\right\rfloor = m.
      \label{eq:floor}
   \end{align*}

   Let $u_0=0$, $u_{i+1} = \lfloor\frac{q}{c}u_i+1\rfloor$.
   By induction $u_i \ge (q/c)^{i-1}$ for $i>0$.
   This is trivial for $i=1$ and $u_{i+1}=\lfloor \frac qc u_i +1\rfloor \ge \lfloor (q/c)^i + 1 \rfloor \ge (q/c)^i$.

   Now define $E_i\in\mathbb Z$ such that $v_i = m - E_i$.
   We will show by induction that $0\le E_{i} \le u_{n-i}$ for $0\le i\le n$ such that $E_n = 0$, which gives the theorem.
   For a start $E_0=m\ge 0$ and $E_0 = \lfloor x/(q-c)\rfloor \le (q/c)^{n-1} \le u_n$.

   For $c\setminus q$ we can be slightly more specific, and support $x \le c (q/c)^n-c$.
   This follows by noting that $u_i = \frac{(q/c)^i-1}{q/c-1}$ for $i>0$, since all the $q/c$ terms are integral.
   Thus for $E_0=\floor{x/(q-c)}\le u_n$ it suffices to require $x\le c q^n-c$.

   For the induction step we plug in our expressions for $x$ and $v_i$:
   \begin{align*}
      v_{i+1}
      &= \left\lfloor \frac{(m-E_i+1)c+m(q-c)+h}{q}\right\rfloor
    \\&=
    m
    +
    \left\lfloor \frac{(- E_i+1)c +h}{q}\right\rfloor
    \\&=
    m
    - \left\lceil \frac{(E_i-1)c - h}{q}\right\rceil.
   \end{align*}
   The lower bound follows easily from $E_i \ge 0$ and $h\le q-c-1$:
   $$E_{i+1} = \left\lceil \frac{E_ic - h - c}{q}\right\rceil \ge
   \left\lceil \frac{- q + 1}{q}\right\rceil = 0.$$
   For the upper bound we use the inductive hypothesis as well as the bound $h\ge 0$:
   \begin{align*}
      E_{i+1}
      &= \left\lceil \frac{(E_i-1)c - h}{q}\right\rceil
    \\&\le\left\lceil (u_{n-i}-1)\frac{c}{q}\right\rceil
    \\&= \left\lceil \left\lfloor \frac{q}{c}u_{n-i-1} \right\rfloor \frac{c}{q}\right\rceil
    \\&\le \left\lceil u_{n-i-1}\right\rceil
    \\&= u_{n-i-1}.
   \end{align*}
   The last equality comes from $u_{n-i-1}$ being an integer.
   Having thus bounded the errors, the proof is complete.
\end{proof}
We can also note that if the algorithm is repeated more than $n$ times, the error stays at 0, since 
$\lceil (u_{n-i}-1)\frac{c}{q}\rceil = \lceil -\frac{c}{q}\rceil = 0$.
   %In particular, for $c=1$ and $x < q^2$ we have
   %$
   %\left\lfloor\frac{x}{q-1}\right\rfloor
   %= v_2
   %= \left\lfloor\frac{\left\lfloor\frac{x+1}{q}\right\rfloor+x+1}{q}\right\rfloor
   %$.
