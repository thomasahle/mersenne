\section{Generalized analysis}

The general analysis use the following strong assumption.
\begin{assumption}\label{ass:independence}
    For distinct keys $x_0, \ldots x_{j - 1}$, $j \le k$
    and an expression $A(i_{x_0}, \ldots, i_{x_{j - 1}}, s_{x_1}, \ldots, s_{x_{j - 1}})$,
    which depends on $i_{x_0}, \ldots, i_{x_{j - 1}}$ and $s_{x_1}, \ldots, s_{x_{j - 1}}$
    but not on $s_{x_0}$. Then
    \begin{align}
        \E[s_{x_0} A(i_{x_0}, \ldots, i_{x_{j - 1}}, s_{x_1}, \ldots, s_{x_{j - 1}})] = 0\; .
    \end{align}
\end{assumption}
We will show our result using the following weaker assumption.
\begin{assumption}\label{ass:near-independence}
    There exists $l \in [r]$ such that for distinct keys $x_0, \ldots x_{j - 1}$, $j \le k$
    and an expression $A(i_{x_0}, \ldots, i_{x_{j - 1}}, s_{x_1}, \ldots, s_{x_{j - 1}})$,
    which depends on $i_{x_0}, \ldots, i_{x_{j - 1}}$ and $s_{x_1}, \ldots, s_{x_{j - 1}}$
    but not on $s_{x_0}$. Then
    \begin{align}\label{eq:near-independence}
        \E[s_{x_0} A(i_{x_0}, \ldots, i_{x_{j - 1}}, s_{x_1}, \ldots, s_{x_{j - 1}})]
            = \E[A(i_{x_0}, \ldots, i_{x_{j - 1}}, s_{x_1}, \ldots, s_{x_{j - 1}}) \mid i_{x_0} = l]/p \; .
    \end{align}
    Furthermore, there exists $\delta$ such that for any key $x$, then
    \begin{align}\label{eq:prob-special-value}
        \Pr[i_x = l] \le (1 + \delta)/r \; .
    \end{align}
\end{assumption}

For both of the analyses we will need the following assumption
\begin{assumption}\label{ass:collision}
    There exists a value $a$ such that for distinct keys $x \neq y$,
    then
    \begin{align}\label{eq:collision}
        \Pr[i_x = i_y] \le (1 + \eps)/r\; .
    \end{align}
\end{assumption}

\paragraph{Uniform bits to arbitrary bins.}
Then \Cref{ass:independence} is satisfied and \Cref{ass:collision} is
satisfied with $\eps = (r/(2q))^2$.

\paragraph{Mersenne to power of two.}
Then \Cref{ass:near-independence} is satisfied with $l = 2^l - 1$ and
$\delta = -(r - 1)/p$ and \Cref{ass:collision} is satisfied
with $\eps = (r - 1)/p^2$.

\paragraph{Mersenne to arbitrary bins.}
Then \Cref{ass:near-independence} is satisfied with $l = 0$ and
$\delta = r/2^b$ and \Cref{ass:collision} is satisfied
with $\eps = (r/2^b)^2$.

\begin{lemma}
    If \Cref{ass:near-independence} is satisfied with $l$
    and $\delta$ and \Cref{ass:collision} is satisfied with
    $\eps$, then
    \begin{align}
        \E[X] &= F_2^2 + (F_1^2 - F_2^2)/p^2 \le (1 + (n - 1)/p^2)F_2^2\\
        \Var[X] &\le 2F_2^4/r + F_2^4 (2\eps/r + 4(1 + \delta)n / (rp^2) + n^2/p^4 - 2 /(rn))
    \end{align}
\end{lemma}
\begin{proof}
    We first bound $\E[s_x s_y f_x f_y [i_x = i_y]]$ for distinct keys
    $x \neq y$. Using \cref{eq:near-independence} twice we get that
    \begin{equation}\begin{split}\label{eq:twice-split}
        \E[s_x s_y f_x f_y [i_x = i_y]]
            &= \E[s_x f_x f_y [i_x = i_y] \mid i_y = l]/p
            \\&= \E[s_x f_x f_y [i_x = l]]/p
            \\&= \E[f_x f_y [i_x = l] \mid i_x = l]/p
            \\&= f_x f_y / p^2 \; .
    \end{split}\end{equation}
    From this we can calculate $\E[X]$.
    \begin{align*}
        \E[X]
            = F_2^2 + \sum_{x \neq y} \E[s_x s_y f_x f_y [i_x = i_y]]
            = F_2^2 + (F_1^2 - F_2^2)/p^2
            \le (1 + (n - 1)/p^2)F_2^2 \; ,
    \end{align*}
    where the last inequality follows from Cauchy-Schwartz. This shows the first result.

    Same method is applied to the analysis of the variance, which is
    \[
        \Var[X]
            = \Var[Y]
            \le \E[Y^2]
            = \sum_{x,y,x',y' \in [u], x \neq y, x' \neq y'} \E[(s_x s_y f_x f_y [i_x = i_y]) (s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
        \; .
    \] 
    Consider any term in the sum. Suppose some key, say $x$, is unique in the
    sense that $x \not \in \{y,x',y'\}$. Then we can apply \cref{eq:near-independence}.
    Given that $x \neq y$ and $x'\neq y'$, we have either $2$ or $4$ such unique keys.
    If all 4 keys are distinct, as in \cref{eq:twice-split}, we get
    \begin{align*}
        \E[(s_x s_y f_x f_y [i_x = i_y]) &(s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \\&= \E[(s_x s_y f_x f_y [i_x = i_y])] \E[s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \\&= (f_x f_y/p^2)(f_{x'} f_{y'}/p^2)
            \\&= f_x f_y f_{x'} f_{y'}/p^4
        \; .
    \end{align*}
    The expected sum over all such terms is thus bounded
    as 
    \begin{equation}\begin{split}
        \sum_{{\rm distinct}\, x,y,x',y'\in[u]}& \E[(s_x s_y f_x f_y [i_x = i_y]) (s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \\&= \sum_{{\rm distinct}\,x,y,x',y'\in[u]} f_xf_yf_{x'}f_{y'}/p^4
            \\&\le F_1^4 /p^4
            \\&\le F_2^2 n^2/p^4.\label{eq:distinct}
    \end{split}\end{equation}
    Where the last inequality used Cauchy-Schwartz. We also have to consider all the cases with
    two unique keys, e.g., $x$ and $x'$ unique while $y=y'$. Then using \cref{eq:near-independence}
    and \cref{eq:prob-special-value}, we get
    \begin{align*}
        \E[(s_x s_y f_x f_y [i_x = i_y]) &(s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \\&= f_x f_{x'} f_y^2 \E[s_x s_{x'} [i_x = i_{x'} = i_y]]
            \\&= f_x f_{x'} f_y^2 \E[s_{x'} [l = i_{x'} = i_y]]/p
            \\&= f_x f_{x'} f_y^2 \E[l = i_y]/p^2
            \\&\le f_x f_{x'} f_y^2(1 + \delta)/(rp^2).
    \end{align*}    
    Summing over all terms with $x$ and $x'$ unique while $y=y'$, and
    using Cauchy-Schwartz and $u\leq p$, we get 
    \begin{align*}
        \sum_{{\rm distinct}\,x,x',y} f_xf_{x'}f_y^2 (1 + \delta) /(rp^2) 
            \le F_1^2F_2^2 (1 + \delta)/(rp^2)
            \le F_2^4 n(1 + \delta)/(rp^2).
    \end{align*}
    There are four ways we can pick the two unique keys $a\in \{x,y\}$
    and $b\in \{x',y'\}$, so we conclude that
    \begin{equation}\label{eq:one-pair}
        \sum_{\begin{array}{c}
            x,y,x',y'\in[u], x\neq y, x'\neq y',\\
            {\rm two\ keys\ are\ unique}
        \end{array}}
        \E[(s_x s_y f_x f_y [i_x = i_y]) (s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \le 4 F_2^4 n(1 + \delta)/(rp^2) .
    \end{equation}
    Finally, we need to reconsider the terms with two pairs, that
    is where $(x,y)=(x',y')$ or $(x,y)=(y',x')$. In
    this case, $(s_x s_y f_x f_y [i_x = i_y]) (s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}]) = f_x^2 f_y^2 [i_x = i_y]$.
    By \cref{eq:collision}, we get 
    \begin{equation}\begin{split}    
        \sum_{\begin{array}{c}
            x,y,x',y'\in[u], x\neq y, x'\neq y',\\
            (x,y)=(x',y')\,\vee\,(x,y)=(y',x')
        \end{array}}&
            \E[(s_x s_y f_x f_y [i_x = i_y]) (s_{x'} s_{y'} f_{x'} f_{y'}[i_{x'} = i_{y'}])]
            \\&=2\sum_{x,y\in[u],x\neq y} f_x^2f_y^2 \Pr[i_x=i_y]
            \\&=2\sum_{x,y\in[u],x\neq y} f_x^2f_y^2 (1 + \eps)/r
            \\&=2(F_2^4 - F_4^4)(1 + \eps)/r .\label{eq:two-pairs}
    \end{split}\end{equation}
    Adding up add \req{eq:distinct}, \req{eq:one-pair}, and
    \req{eq:two-pairs}, we get 
    \begin{align*}
        \Var[Y]
            &\le 2(1 + \eps)(F_2^4 - F_4^4)/r + F_2^4(4(1 + \delta) n / (rp^2) + n^2/p^4)
            \\&\le 2F_2^4/r + F_2^4 (2\eps/r + 4(1 + \delta)n / (rp^2) + n^2/p^4 - 2 /(rn)) .
    \end{align*}
    This finishes the proof.
\end{proof}

\begin{corollary}
    We get the following results
    \begin{itemize}
        \item \textbf{Mersenne to power of two:}
            \[
                \Var[X] \le 2 F_2^4/r .
            \]
        \item \textbf{Mersenne to arbitrary number of bins:}
            \[
                \Var[X] \le 2 (1 + (r/(p + 1))^2) F_2^4/r .
            \]
    \end{itemize}
\end{corollary}
\begin{proof}
    We will use that we know that $2 \le r \le u/2 \le (p + 1)/4$ and $n \le u$.
    This implies that $p \ge 7$ and that $n/p \le u/p \le 4/7$.

    \paragraph{Mersenne to power of two.} We then know that $\delta = -(r - 1)/p \le 0$ 
    and $\eps = (r - 1)/p^2 \le r/p^2$. We want to prove that
    $2\eps/r + 4(1 + \delta)n / (rp^2) + n^2/p^4 - 2/(rn) \le 0$ which would
    prove our result. We get that
    \begin{align*}
        2\eps/r + 4(1 + \delta)n / (rp^2) + n^2/p^4 - 2/(rn) 
            &\le 2/p^2 + 4n/(r p^2) + n^2/p^4 - 2/(rn)
            \\&\le 2/p^2 + 4u/(r p^2) + u^2/p^4 - 2/(ru) .
    \end{align*}
    Now we note that $4u/(r p^2) - 2/(ru) = (2u^2 - p^2)/(u p^2 r) \le 0$
    since $u \le (p + 1)/2$ so it maximized when $r = u/2$. We then get
    that
    \begin{align*}
        2/p^2 + 4u/(r p^2) + u^2/p^4 - 2/(ru)
            \le 2/p^2 + 8/p^2 + u^2 / p^4 - 4/u^2 .
    \end{align*}
    We now use that $u/p \le (4/7)^2$ and get that
    \begin{align*}
        2/p^2 + 8/p^2 + u^2 / p^4 - 4/u^2
            \le (10 + (4/7)^2 - 4 (7/4)^2)/p^2
            \le 0 .
    \end{align*}
    This finishes the first part.
    
    \paragraph{Mersenne to arbitrary number of bins.} We then know that
    $\delta = r/(p + 1) \le r/p$ and $\eps = r^2/(p + 1)^2$.
    We have that
    \begin{align*}
        \Var[X]
            &= 2F_2^4/r + F_2^4 (2\eps/r + 4(1 + \delta)n / (rp^2) + n^2/p^4 - 2 /(rn))
            \\&= 2(1 + \eps)F_2^4/r + F_2^4(4(1 + \delta)n / (rp^2) + n^2/p^4 - 2 / (rn))
            \\&\le 2(1 + r^2/(p + 1)^2) F_2^4/r + F_2^4(4(1 + r/p)n / (rp^2) + n^2/p^4 - 2 / (rn))
        .
    \end{align*}
    If we can prove that $4(1 + r/p)n / (rp^2) + n^2/p^4 - 2 / (rn) \le 0$ then
    we have the result. We have that
    \begin{align*}
        4(1 + r/p)n / (rp^2) + n^2/p^4 - 2 / (rn)
            &= 4 n/(rp^2) + 4 n /(p^3) + n^2/p^4 - 2/(rn)
            \\&\le 4u/(rp^2) + 4u/(p^3) + u^2/p^4 - 2/(ru) .
    \end{align*}
    Again we note that $4u/(r p^2) - 2/(ru) = (2u^2 - p^2)/(u p^2 r) \le 0$
    since $u \le (p + 1)/2$ so it maximized when $r = u/2$. We then get
    that
    \begin{align*}
       4u/(r p^2) + 4u/(p^3) + u^2/p^4 - 2/(ru)
            \le 8/p^2 + 4u/(p^3) + u^2/p^4 - 4/u^2 .
    \end{align*}
    We now use that $u/p \le (4/7)^2$ and get that
    \begin{align*}
        8/p^2 + 4u/(p^3) + u^2/p^4 - 4/u^2 .
            \le (8 + 4 (4/7) + (4/7)^2 - 4 (7/4)^2)/p^2
            \le 0 .
    \end{align*}
    This finishes the second part.
\end{proof}
